<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Evaluación de Equipo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FDFBF8;
            color: #4A4A4A;
        }
        .tab-active {
            background-color: #3B82F6;
            color: #FFFFFF;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .tab-inactive {
            background-color: #FFFFFF;
            color: #3B82F6;
        }
        .card {
            background-color: #FFFFFF;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: all 0.3s ease-in-out;
        }
        .task-item {
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .task-item.completed {
            text-decoration: line-through;
            color: #9CA3AF;
        }
        .task-item.completed .check-icon {
            opacity: 1;
            transform: scale(1);
        }
        .check-icon {
            opacity: 0;
            transform: scale(0.5);
            transition: all 0.2s ease-in-out;
        }
        .slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #3B82F6;
            cursor: pointer;
            border-radius: 50%;
        }
        .slider-track {
            width: 100%;
            height: 8px;
            cursor: pointer;
            background: #E5E7EB;
            border-radius: 9999px;
        }
        .pdf-page-break {
            page-break-after: always;
        }
        
        #results-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }

        @media (min-width: 1024px) {
            #results-container {
                grid-template-columns: 2fr 1fr;
            }
        }
    </style>
</head>
<body class="antialiased">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-6xl">
        <header class="text-center mb-10">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Panel de Evaluación de Equipo</h1>
            <p class="mt-2 text-lg text-gray-600">Evalúa y da seguimiento a las habilidades de servicio al cliente de tu equipo.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div id="start-screen" class="lg:col-span-3 card p-8 flex flex-col items-center justify-center">
                <div class="w-full max-w-sm text-center">
                    <label for="evaluator-name-input" class="block font-bold text-gray-700 mb-2">Nombre del evaluador:</label>
                    <input type="text" id="evaluator-name-input" placeholder="Tu nombre" class="w-full px-4 py-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-center text-lg mb-4">
                    
                    <label for="employee-name-input" class="block font-bold text-gray-700 mb-2">Nombre del empleado:</label>
                    <input type="text" id="employee-name-input" placeholder="Nombre del empleado" class="w-full px-4 py-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-center text-lg">
                    
                    <button id="start-evaluation-btn" class="mt-6 px-8 py-3 bg-blue-600 text-white font-bold rounded-md hover:bg-blue-700 transition">Iniciar Evaluación</button>
                </div>
            </div>

            <div id="evaluation-screen" class="lg:col-span-3 hidden">
                <div class="lg:col-span-2">
                    <div id="evaluation-meta" class="card p-4 mb-4 text-center">
                        <p class="text-sm text-gray-600">Evaluación para <span id="employee-name-title" class="font-bold text-gray-800"></span> realizada por <span id="evaluator-name-title" class="font-bold text-gray-800"></span> el <span id="evaluation-date-title" class="font-bold text-gray-800"></span> a las <span id="evaluation-time-title" class="font-bold text-gray-800"></span></p>
                    </div>
                    <div id="content" class="card p-6 min-h-[400px]"></div>
                    <div class="flex justify-between mt-4">
                        <button id="prev-btn" class="px-6 py-2 bg-gray-300 text-gray-700 font-bold rounded-md hover:bg-gray-400 transition" disabled>Anterior</button>
                        <button id="next-btn" class="px-6 py-2 bg-blue-600 text-white font-bold rounded-md hover:bg-blue-700 transition">Siguiente</button>
                    </div>
                </div>
                
                <aside class="lg:col-span-1 mt-8 lg:mt-0">
                    <div class="card p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Progreso Actual de <span id="employee-name-title-aside"></span></h2>
                        <p class="text-sm text-gray-600 mb-6">Utiliza los deslizadores en cada sección para evaluar el nivel de confianza (1 a 3). El progreso se reflejará aquí.</p>
                        <div class="chart-container relative h-80 w-full max-w-sm mx-auto">
                            <canvas id="progressChart"></canvas>
                        </div>
                    </div>
                </aside>
            </div>
        </main>
    </div>

    <script>
        const initialSkills = {
            'saludo': {
                title: 'Saludo',
                intro: 'Un saludo efectivo crea una primera impresión fuerte. Te guiaré para que cada interacción comience de manera positiva, haciendo que el cliente se sienta genuinamente bienvenido.',
                tasks: [
                    { text: 'Entiende el propósito de la frase, no solo repetirla.', completed: false },
                    { text: 'Utiliza la frase con una sonrisa genuina para añadir calidez.', completed: false },
                    { text: 'Elige el momento correcto para saludar al cliente, justo al iniciar el contacto.', completed: false }
                ],
                score: 1
            },
            'contacto': {
                title: 'Contacto Visual',
                intro: 'El contacto visual es clave para construir confianza y demostrar que estás prestando atención. Aquí encontrarás técnicas para mantener un contacto visual adecuado sin sentirte incómodo, proyectando seguridad y sinceridad.',
                tasks: [
                    { text: 'Se concentra en el punto entre las cejas si mirar a los ojos es difícil.', completed: false },
                    { text: 'Mantiene el contacto mientras el cliente habla.', completed: false },
                    { text: 'Evita distracciones externas y enfócate en la conversación.', completed: false }
                ],
                score: 1
            },
            'amabilidad': {
                title: 'Amabilidad en la Comunicación',
                intro: 'La amabilidad se transmite tanto con las palabras como con la actitud. Aprende a utilizar un lenguaje positivo y a practicar la escucha activa para transformar cada conversación en una experiencia agradable y constructiva.',
                tasks: [
                    { text: 'Usa lenguaje positivo (ej. con mucho gusto).', completed: false },
                    { text: 'Sonríe mientras habla para un tono más cálido.', completed: false },
                    { text: 'Practica la escucha activa asintiendo o resumiendo lo que escucha.', completed: false }
                ],
                score: 1
            },
            'despedida': {
                title: 'Despedida',
                intro: 'Una despedida bien hecha deja una impresión positiva y duradera. Aprende a cerrar cada interacción de manera profesional y amable, reforzando la buena experiencia del cliente.',
                tasks: [
                    { text: 'Hace que la despedida sea tan amable como el saludo.', completed: false },
                    { text: 'Asegura que el cliente no necesita nada más antes de despedirse.', completed: false },
                    { text: 'Utiliza la frase de despedida.', completed: false }
                ],
                score: 1
            },
            'resultados': {
                title: 'Resultados',
                intro: 'Revisa las puntuaciones finales de la evaluación para obtener una visión completa del desempeño del empleado.',
                tasks: [],
                score: 0
            }
        };

        const steps = ['saludo', 'contacto', 'amabilidad', 'despedida', 'resultados'];
        let employeesData = JSON.parse(localStorage.getItem('employeesData')) || {};
        let activeEmployeeName = '';
        let currentStepIndex = 0;
        let progressChart;

        const startScreen = document.getElementById('start-screen');
        const evaluationScreen = document.getElementById('evaluation-screen');
        const contentContainer = document.getElementById('content');
        const evaluatorNameInput = document.getElementById('evaluator-name-input');
        const employeeNameInput = document.getElementById('employee-name-input');
        const startEvaluationBtn = document.getElementById('start-evaluation-btn');
        const employeeNameTitle = document.getElementById('employee-name-title');
        const evaluatorNameTitle = document.getElementById('evaluator-name-title');
        const evaluationDateTitle = document.getElementById('evaluation-date-title');
        const evaluationTimeTitle = document.getElementById('evaluation-time-title');
        const employeeNameTitleAside = document.getElementById('employee-name-title-aside');
        const nextBtn = document.getElementById('next-btn');
        const prevBtn = document.getElementById('prev-btn');

        function saveState() {
            localStorage.setItem('employeesData', JSON.stringify(employeesData));
            localStorage.setItem('lastActiveEmployee', activeEmployeeName);
            localStorage.setItem('lastEvaluator', evaluatorNameInput.value);
        }

        function loadEmployee(name, evaluator) {
            if (!name) return;

            const now = new Date();
            const date = now.toLocaleDateString('es-ES');
            const time = now.toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit'});

            if (!employeesData[name]) {
                employeesData[name] = { 
                    skills: JSON.parse(JSON.stringify(initialSkills)),
                    evaluationMeta: { evaluator, date, time }
                };
            } else {
                employeesData[name].evaluationMeta = { evaluator, date, time };
            }

            activeEmployeeName = name;
            currentStepIndex = 0;
            render();
            startScreen.classList.add('hidden');
            evaluationScreen.classList.remove('hidden');
            saveState();
        }

        function renderContent() {
            if (!activeEmployeeName) {
                contentContainer.innerHTML = '';
                employeeNameTitle.textContent = '';
                employeeNameTitleAside.textContent = '';
                evaluatorNameTitle.textContent = '';
                evaluationDateTitle.textContent = '';
                evaluationTimeTitle.textContent = '';
                return;
            }
            
            const activeStep = steps[currentStepIndex];
            const data = employeesData[activeEmployeeName].skills[activeStep];
            const meta = employeesData[activeEmployeeName].evaluationMeta;

            employeeNameTitle.textContent = activeEmployeeName;
            employeeNameTitleAside.textContent = activeEmployeeName;
            evaluatorNameTitle.textContent = meta.evaluator || 'N/A';
            evaluationDateTitle.textContent = meta.date || 'N/A';
            evaluationTimeTitle.textContent = meta.time || 'N/A';

            if (activeStep === 'resultados') {
                const skills = employeesData[activeEmployeeName].skills;
                
                let resultsHTML = Object.keys(skills).map(key => {
                    if (key !== 'resultados') {
                        const taskList = skills[key].tasks.map(task => `<li>${task.text} - ${task.completed ? 'Cumplido' : 'No cumplido'}</li>`).join('');
                        return `
                        <div class="p-4 rounded-lg bg-gray-50 mb-4">
                            <h3 class="font-bold text-lg text-gray-700">${skills[key].title}: <span class="font-semibold text-blue-600">${skills[key].score}/3</span></h3>
                            <ul class="list-disc list-inside text-sm text-gray-600 mt-2">${taskList}</ul>
                        </div>`;
                    }
                }).join('');

                contentContainer.innerHTML = `
                    <h2 class="text-2xl font-bold text-gray-800 mb-3">${data.title}</h2>
                    <p class="text-gray-600 mb-6">${data.intro}</p>
                    <div id="results-view">${resultsHTML}</div>
                    <div class="mt-8 text-center">
                        <button id="download-pdf-btn" class="px-8 py-3 bg-green-600 text-white font-bold rounded-md hover:bg-green-700 transition">Descargar PDF</button>
                    </div>
                `;

                document.getElementById('download-pdf-btn').addEventListener('click', generatePdf);

            } else {
                contentContainer.innerHTML = `
                    <h2 class="text-2xl font-bold text-gray-800 mb-3">${data.title}</h2>
                    <p class="text-gray-600 mb-6">${data.intro}</p>
                    <div id="task-list" class="space-y-4 mb-8">
                        ${data.tasks.map((task, index) => `
                            <div class="task-item flex items-center p-3 rounded-lg hover:bg-gray-50 ${task.completed ? 'completed' : ''}" onclick="toggleTask(${index})">
                                <div class="w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center mr-4 flex-shrink-0">
                                    <span class="check-icon text-blue-500">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check" viewBox="0 0 16 16">
                                            <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425z"/>
                                        </svg>
                                    </span>
                                </div>
                                <span class="flex-grow">${task.text}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="mt-auto pt-6 border-t border-gray-200">
                        <label for="skill-slider" class="block font-semibold text-gray-700 mb-2">Puntuación: <span id="slider-value" class="font-bold text-blue-600">${data.score}</span>/3</label>
                        <input type="range" id="skill-slider" min="1" max="3" value="${data.score}" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider-track">
                    </div>
                `;
                
                const slider = document.getElementById('skill-slider');
                const sliderValue = document.getElementById('slider-value');
                slider.oninput = (event) => {
                    const value = event.target.value;
                    employeesData[activeEmployeeName].skills[activeStep].score = parseInt(value, 10);
                    sliderValue.textContent = value;
                    updateChart();
                    saveState();
                };
            }
        }
        
        async function generatePdf() {
            const employeeSkills = employeesData[activeEmployeeName].skills;
            const meta = employeesData[activeEmployeeName].evaluationMeta;
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const margin = 15;
            let yPos = margin;
            const contentWidth = doc.internal.pageSize.getWidth() - 2 * margin;

            // Título principal y metadatos en la primera página
            doc.setFontSize(22);
            yPos += 15;
            doc.text("Reporte de Evaluación de Equipo", doc.internal.pageSize.getWidth() / 2, yPos, { align: 'center' });
            yPos += 10;
            doc.setFontSize(14);
            doc.text("Reporte detallado de las habilidades de servicio al cliente.", doc.internal.pageSize.getWidth() / 2, yPos, { align: 'center' });
            yPos += 20;
            doc.setFontSize(12);
            doc.text(`Evaluación para ${activeEmployeeName} realizada por ${meta.evaluator} el ${meta.date} a las ${meta.time}`, margin, yPos);
            yPos += 15;

            // Agregar secciones de habilidades
            doc.setFontSize(16);
            doc.text("Detalles de la Evaluación", margin, yPos);
            yPos += 10;
            
            Object.keys(employeeSkills).forEach(key => {
                if (key !== 'resultados') {
                    const skill = employeeSkills[key];
                    if (yPos > doc.internal.pageSize.getHeight() - margin - 40) {
                        doc.addPage();
                        yPos = margin;
                    }

                    doc.setFontSize(14);
                    doc.setTextColor(0, 0, 0); // Color negro para el título de la habilidad
                    doc.text(`${skill.title}: ${skill.score}/3`, margin, yPos);
                    yPos += 7;

                    skill.tasks.forEach(task => {
                        const completionStatus = task.completed ? 'Cumplido' : 'No cumplido';
                        const taskText = `${task.text} - ${completionStatus}`;
                        const lines = doc.splitTextToSize(taskText, contentWidth - 10);
                        doc.setFontSize(12);
                        if (task.completed) {
                            doc.setTextColor(40, 167, 69); // Verde para "Cumplido"
                        } else {
                            doc.setTextColor(220, 53, 69); // Rojo para "No cumplido"
                        }
                        doc.text(lines, margin + 5, yPos);
                        yPos += (lines.length * 5) + 5;
                        if (yPos > doc.internal.pageSize.getHeight() - margin - 20) {
                            doc.addPage();
                            yPos = margin;
                        }
                    });
                    yPos += 5;
                }
            });

            // Mover a la siguiente página para la gráfica
            doc.addPage();
            yPos = margin + 15;
            
            // Generar la imagen del gráfico y agregarla
            const chartCanvas = document.getElementById('progressChart');
            const chartDataUrl = chartCanvas.toDataURL('image/png', 1.0);
            const chartHeight = (contentWidth / chartCanvas.width) * chartCanvas.height;
            doc.addImage(chartDataUrl, 'PNG', margin, yPos, contentWidth, chartHeight);
            
            // Guardar el PDF
            doc.save(`Reporte_${activeEmployeeName.replace(/\s/g, '_')}.pdf`);
        }
        
        function toggleTask(index) {
            const activeStep = steps[currentStepIndex];
            employeesData[activeEmployeeName].skills[activeStep].tasks[index].completed = !employeesData[activeEmployeeName].skills[activeStep].tasks[index].completed;
            renderContent();
            saveState();
        }

        function renderChart() {
            if (!activeEmployeeName) {
                if (progressChart) progressChart.destroy();
                return;
            }

            const ctx = document.getElementById('progressChart').getContext('2d');
            const employeeSkills = employeesData[activeEmployeeName].skills;
            const labels = Object.values(employeeSkills).filter(skill => skill.title !== 'Resultados').map(item => item.title);
            const data = Object.values(employeeSkills).filter(skill => skill.title !== 'Resultados').map(item => item.score);
            
            if (progressChart) {
                progressChart.destroy();
            }

            progressChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Nivel de Habilidad',
                        data: data,
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(59, 130, 246, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            pointLabels: {
                                font: {
                                    size: 12,
                                    weight: '500'
                                },
                                color: '#4A4A4A'
                            },
                            ticks: {
                                beginAtZero: true,
                                min: 0,
                                max: 3,
                                stepSize: 1,
                                backdropColor: 'rgba(255, 255, 255, 0.75)',
                                color: '#6B7280'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Puntuación: ${context.raw}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateChart() {
            if (progressChart) {
                progressChart.data.datasets[0].data = Object.values(employeesData[activeEmployeeName].skills).filter(skill => skill.title !== 'Resultados').map(item => item.score);
                progressChart.update();
            }
        }

        function updateButtons() {
            prevBtn.disabled = currentStepIndex === 0;
            nextBtn.textContent = (currentStepIndex === steps.length - 1) ? 'Terminar Evaluación' : 'Siguiente';
        }

        function render() {
            renderContent();
            renderChart();
            updateButtons();
        }

        startEvaluationBtn.addEventListener('click', () => {
            const name = employeeNameInput.value.trim();
            const evaluator = evaluatorNameInput.value.trim();
            if (name) {
                loadEmployee(name, evaluator);
            }
        });

        employeeNameInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                const name = employeeNameInput.value.trim();
                const evaluator = evaluatorNameInput.value.trim();
                if (name) {
                    loadEmployee(name, evaluator);
                }
            }
        });

        nextBtn.addEventListener('click', () => {
            if (currentStepIndex < steps.length - 1) {
                currentStepIndex++;
                render();
            } else {
                startScreen.classList.remove('hidden');
                evaluationScreen.classList.add('hidden');
                employeeNameInput.value = '';
                activeEmployeeName = '';
            }
        });

        prevBtn.addEventListener('click', () => {
            if (currentStepIndex > 0) {
                currentStepIndex--;
                render();
            }
        });
        
        document.addEventListener('DOMContentLoaded', () => {
            const lastActiveName = localStorage.getItem('lastActiveEmployee');
            const lastEvaluator = localStorage.getItem('lastEvaluator');
            if (lastEvaluator) { evaluatorNameInput.value = lastEvaluator; }
            
            if (lastActiveName && employeesData[lastActiveName]) {
                employeeNameInput.value = lastActiveName;
                loadEmployee(lastActiveName, lastEvaluator);
            }
        });
    </script>
</body>
</html>
